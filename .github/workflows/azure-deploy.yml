name: Build and Deploy ASP.NET Core App to Azure Web App

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: student-api-auth-app
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'RegistrationApi.csproj'   # ✅ updated path

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: ⬇️ Checkout code
      uses: actions/checkout@v3

    - name: 🧰 Setup .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 🔨 Restore dependencies
      run: dotnet restore ${{ env.PROJECT_PATH }}

    - name: ⚙️ Build
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

    - name: 📦 Publish
      run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --output publish_output

    - name: 🔐 Login to Azure using Service Principal
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 🚀 Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: publish_output
